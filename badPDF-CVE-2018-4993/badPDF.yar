private rule isPDF: PDF
{
	meta:
		Author = "Zahid Adeel (zahidadeelhashmat@gmail.com)"
		Description = "Identify PDF document"
		Version = "0.1"
		
	strings:
		$magic = { 25 50 44 46 }

	condition:
		/*PDF header should have magic within 0 to 1024 offset limit*/
		$magic in (0..1024)
}


rule badPDF_NTLM_Creds_Hijacker : PDF
{
	meta:
		Author = "Zahid Adeel (zahidadeelhashmat@gmail.com)"
		Description = "Hijacking NTLM Credentials using PDF Files (CVE-2018-4993)"
		Reference = "https://research.checkpoint.com/ntlm-credentials-theft-via-pdf-files/"
		Version = "0.1"
		
	strings:
		/*
		Payload linked at UNC path can be be executed on PDF page open(/O) or close(/C) by /AA entery which is meant for auto action.
		Goto E or R are enough alongwith /F UNC path pattern to identify this vulnerability
		*/
					    	
		$UNCPayload1 = /\/AA\s*<<\s*\/[OC]\s*<<[^\>]*\/F\s*\(\\\\\\\\[^\\]+\\[^\)\>]+\)[^\>]+\/S\s*\/GoTo[ER][^\>]+>>/
		$UNCPayload2 = /\/AA\s*<<\s*\/[OC]\s*<<[^\>]*\/S\s*\/GoTo[ER][^\>]+\/F\s*\(\\\\\\\\[^\\]+\\[^\)\>]+\)[^\>]+>>/

	condition:
		isPDF and (any of ($UNCPayload*))
} 
